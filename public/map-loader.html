<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>百度地图加载器</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        #mapContainer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="mapContainer"></div>

    <!-- 直接加载百度地图-->
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=aRVvjOUyolTRKLu5f9cHzshCvTRKQNT2&callback=baiduMapReady"></script>

    <script>
        var mapConfig = null;

        // 百度地图API加载完成回调
        function baiduMapReady() {
            console.log('百度地图API加载完成');

            // 如果已经有配置在等待，立即初始化地图
            if (mapConfig) {
                initBaiduMap(mapConfig);
            }

            // 通知父窗口API已准备就绪
            window.parent.postMessage({
                type: 'apiReady'
            }, '*');
        }

        // 等待来自父窗口的配置
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'initMap') {
                console.log('收到地图配置:', event.data.config);
                mapConfig = event.data.config;

                // 如果API已经准备好，立即初始化地图
                if (window.BMap && window.BMap.Map) {
                    initBaiduMap(mapConfig);
                } else {
                    console.log('等待百度地图API加载完成...');
                }
            }
        });

        function initBaiduMap(config) {
            try {
                console.log('正在初始化百度地图，配置:', config);

                // 创建地图实例
                var map = new BMap.Map(document.getElementById('mapContainer'));

                // 设置地图中心点和缩放级别
                var point = new BMap.Point(config.longitude, config.latitude);
                map.centerAndZoom(point, config.zoom || 16);

                // 启用滚轮缩放
                map.enableScrollWheelZoom(true);
                map.enableKeyboard(true);
                map.enableDragging(true);

                // 添加标记点
                var marker = new BMap.Marker(point);
                map.addOverlay(marker);

                // 创建信息窗口内容
                var infoContent = '';

                // 添加信息窗口
                var infoWindow = new BMap.InfoWindow(infoContent, {
                   
                    title: config.title || '位置信息'
                });

                // 默认显示信息窗口
                marker.openInfoWindow(infoWindow);

                // // 点击标记重新打开信息窗口
                marker.addEventListener('click', function() {
                    marker.openInfoWindow(infoWindow);
                });

                // 通知父窗口地图加载完成
                window.parent.postMessage({
                    type: 'mapReady',
                    success: true
                }, '*');

            } catch (error) {
                console.error('百度地图初始化失败:', error);
                window.parent.postMessage({
                    type: 'mapReady',
                    success: false,
                    error: error.message
                }, '*');
            }
        }
    </script>
</body>
</html>
